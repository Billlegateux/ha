- id: set_night
  alias: Energie-Passage en HC
  trigger:
  - platform: time
    at: input_datetime.horaire_hc_debut_1
  - platform: time
    at: input_datetime.horaire_hc_debut_2
  - platform: state
    entity_id: input_boolean.forcage_hc_hp
    to: 'on'
  action:
  - service: input_boolean.turn_off
    data: {}
    entity_id: input_boolean.hc_hp
  - service: utility_meter.select_tariff
    data:
      entity_id:
      - utility_meter.energy_total_usage_daily
      - utility_meter.energy_pisc_usage_daily
      - utility_meter.energy_sdb_usage_daily
      - utility_meter.energy_ecs1_usage_daily
      - utility_meter.energy_pac1_usage_daily
      - utility_meter.energy_total_usage_weekly
      - utility_meter.energy_pisc_usage_weekly
      - utility_meter.energy_sdb_usage_weekly
      - utility_meter.energy_ecs1_usage_weekly
      - utility_meter.energy_pac1_usage_weekly
      - utility_meter.energy_total_usage_monthly
      - utility_meter.energy_pisc_usage_monthly
      - utility_meter.energy_sdb_usage_monthly
      - utility_meter.energy_ecs1_usage_monthly
      - utility_meter.energy_pac1_usage_monthly
      - utility_meter.energy_total_usage_yearly
      - utility_meter.energy_pisc_usage_yearly
      - utility_meter.energy_sdb_usage_yearly
      - utility_meter.energy_ecs1_usage_yearly
      - utility_meter.energy_pac1_usage_yearly
      tariff: hc
  initial_state: true
  mode: single
- id: set_day
  alias: Energie-Passage en HP
  trigger:
  - platform: time
    at: input_datetime.horaire_hp_debut_1
  - platform: time
    at: input_datetime.horaire_hp_debut_2
  - platform: state
    entity_id: input_boolean.forcage_hc_hp
    to: 'off'
  action:
  - service: input_boolean.turn_on
    data: {}
    entity_id: input_boolean.hc_hp
  - service: utility_meter.select_tariff
    data:
      entity_id:
      - utility_meter.energy_total_usage_daily
      - utility_meter.energy_pisc_usage_daily
      - utility_meter.energy_sdb_usage_daily
      - utility_meter.energy_ecs1_usage_daily
      - utility_meter.energy_pac1_usage_daily
      - utility_meter.energy_total_usage_weekly
      - utility_meter.energy_pisc_usage_weekly
      - utility_meter.energy_sdb_usage_weekly
      - utility_meter.energy_ecs1_usage_weekly
      - utility_meter.energy_pac1_usage_weekly
      - utility_meter.energy_total_usage_monthly
      - utility_meter.energy_pisc_usage_monthly
      - utility_meter.energy_sdb_usage_monthly
      - utility_meter.energy_ecs1_usage_monthly
      - utility_meter.energy_pac1_usage_monthly
      - utility_meter.energy_total_usage_yearly
      - utility_meter.energy_pisc_usage_yearly
      - utility_meter.energy_sdb_usage_yearly
      - utility_meter.energy_ecs1_usage_yearly
      - utility_meter.energy_pac1_usage_yearly
      tariff: hp
  initial_state: true
  mode: single
- id: daily_energy_use_message
  alias: 00 - Message Journalier Bilan puissance
  trigger:
  - platform: time
    at: '23:59:00'
  action:
  - service: notify.telegram
    data:
      message: Tot={{states('sensor.energy_total_daily')}} -HP={{states('sensor.energy_total_usage_daily_hp')
        }} -HC={{states('sensor.energy_total_usage_daily_hc') }} {{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Conso Electrique du jour en kWh
  - service: notify.log_energy
    data:
      message: '{{states(''sensor.energy_total_daily'') }},{{states(''sensor.energy_total_usage_daily_hp'')
        }},{{states(''sensor.energy_total_usage_daily_hc'') }},{{states(''sensor.energy_pisc_daily'')
        }},{{states(''sensor.energy_pisc_usage_daily_hp'') }},{{states(''sensor.energy_pisc_usage_daily_hc'')
        }},{{states(''sensor.energy_sdb_daily'') }},{{states(''sensor.energy_sdb_usage_daily_hp'')
        }},{{states(''sensor.energy_sdb_usage_daily_hc'') }},{{states(''sensor.energy_pac1_daily'')
        }},{{states(''sensor.energy_pac1_usage_daily_hp'') }},{{states(''sensor.energy_pac1_usage_daily_hc'')
        }},{{states(''sensor.energy_ecs1_daily'') }},{{states(''sensor.energy_ecs1_usage_daily_hp'')
        }},{{states(''sensor.energy_ecs1_usage_daily_hc'') }}'
      title: Conso Electrique du jour en kWh
  mode: single
- id: '1610184966825'
  alias: Volet_Boolean Nuit/Jour
  description: ''
  trigger:
  - platform: template
    value_template: '{{ states(''sensor.luminosite'' )|float > states(''input_number.luminosite_seuil_haut'')|float
      and is_state("sun.sun", "above_horizon") }}'
    id: nuit->jour
  - platform: template
    value_template: '{{ states(''sensor.luminosite'')|float < states(''input_number.luminosite_seuil_bas'')|float
      and is_state("sun.sun", "below_horizon") }}'
    id: jour->nuit
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: nuit->jour
      sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.nuit_jour
    - conditions:
      - condition: trigger
        id: jour->nuit
      sequence:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.nuit_jour
    default: []
  mode: single
- id: '1610371647929'
  alias: 01 - Purge base de données
  description: ''
  trigger:
  - platform: time
    at: 01:30:00
  condition: []
  action:
  - service: recorder.purge
    data:
      keep_days: 7
      repack: true
  mode: single
- id: '1611218307411'
  alias: Mode_Present/Absent
  description: Passage du mode Presence de Absent ou Vacances à Present
  trigger:
  - platform: state
    entity_id: input_select.presence
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_select.presence
        state: Vacance
      - condition: state
        entity_id: input_select.presence
        state: Absent
      sequence:
      - service: input_select.select_option
        target:
          entity_id:
          - input_select.volets
        data:
          option: Absent
    - conditions:
      - condition: state
        entity_id: input_select.presence
        state: Present
      sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.volets
        data:
          option: Auto
    default: []
  mode: single
- id: '1611514566689'
  alias: Pool Pump On
  description: ''
  trigger:
  - platform: state
    entity_id: input_select.pool_pump_mode
    to: 'On'
  condition: []
  action:
  - service: homeassistant.turn_on
    data: {}
    entity_id: switch.pool_pump_switch
  mode: single
- id: '1611514631258'
  alias: Pool Pump Off
  description: ''
  trigger:
  - platform: state
    entity_id: input_select.pool_pump_mode
    to: 'Off'
  condition: []
  action:
  - service: homeassistant.turn_off
    data: {}
    entity_id: switch.pool_pump_switch
  mode: single
- id: '1611515162753'
  alias: Piscine Check Pool Pump On event
  description: ''
  trigger:
  - platform: homeassistant
    event: start
  - platform: state
    entity_id: sensor.pool_water_temperature
  - platform: state
    entity_id: input_select.pool_pump_mode
  - platform: state
    entity_id: input_boolean.pool_water_level_critical
  condition: []
  action:
  - service: pool_pump.check
  mode: single
- id: '1611568349133'
  alias: Piscine Check pool Pump
  description: ''
  trigger:
  - platform: time_pattern
    minutes: /5
  condition: []
  action:
  - service: pool_pump.check
  mode: single
- id: '1610181804077'
  alias: Piscine Hors_Gel Calcul
  description: ' '
  trigger:
  - platform: numeric_state
    entity_id: sensor.vp2_temp_out
    below: input_number.hors_gel_inf
    id: inf
  - platform: state
    entity_id: sensor.vp2_temp_out
    id: sup
    to: input_number.hors_gel_sup
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: inf
      sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.hors_gel
    - conditions:
      - condition: trigger
        id: sup
      sequence:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.hors_gel
    default: []
  mode: single
- id: '1611586857575'
  alias: Piscine Notification Fin de Cycle
  description: ''
  trigger:
  - platform: time
    at: '23:59:05'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: 'Temps de filtration:  {{states.sensor.pool_pump_running_today.attributes.value}}{{-"\n"-}}Conso:
        {{states(''sensor.energy_pisc_daily'')}} kWh.{{-"\n"-}} Tps Utilisation cart.
        Chlore: {{states(''input_number.temps_cartouche_chlore'')}} h {{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom(''%d/%m/%y-%H:%M:%S'')}}'
      title: Piscine Rapport Fin de journée
  - service: notify.log_piscine
    data:
      message: '{{states.sensor.pool_pump_running_today.attributes.value }},{{states(''sensor.energy_pisc_daily'')}}'
      title: Rapport jour piscine
  mode: single
- id: '1611587048363'
  alias: Piscine Notification Filtration Début
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.pool_pump_running
    to: 'on'
    from: 'off'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: '{{as_timestamp(strptime(now(), "")) | timestamp_custom(''%d/%m %H:%M:%S'')}}'
      title: Piscine Début Filtration
  mode: single
- id: '1611587126924'
  alias: Piscine Notification Filtration Fin
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.pool_pump_running
    from: 'on'
    to: 'off'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: '{{as_timestamp(strptime(now(), "")) | timestamp_custom(''%d/%m %H:%M:%S'')}}'
      title: Piscine Fin de filtration
  mode: single
- id: '1611999559298'
  alias: Notification Pascale home
  description: ''
  trigger:
  - platform: zone
    entity_id: device_tracker.owntrack_pascale
    zone: zone.maison
    event: enter
  condition: []
  action:
  - service: notify.pushbullet
    data:
      message: Pascale retour maison
  mode: single
- id: '1611999613234'
  alias: Notification Pascale no_home
  description: ''
  trigger:
  - platform: zone
    entity_id: device_tracker.owntrack_pascale
    zone: zone.maison
    event: leave
  condition: []
  action:
  - service: notify.pushbullet
    data:
      message: Pascale quitte maison
  mode: single
- id: '1611999675391'
  alias: Notification Remy no_home
  description: ''
  trigger:
  - platform: zone
    entity_id: device_tracker.owntrack_remy
    zone: zone.maison
    event: leave
  condition: []
  action:
  - service: notify.pushbullet
    data:
      message: Remy quitte maison
  mode: single
- id: '1611999722072'
  alias: Notification Remy home
  description: ''
  trigger:
  - platform: zone
    entity_id: device_tracker.owntrack_remy
    zone: zone.maison
    event: enter
  condition: []
  action:
  - service: notify.pushbullet
    data:
      message: Remy retour maison
  mode: single
- id: '1612183951669'
  alias: Bureau-Ampoule On
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.detecteur_presence1_ias_zone
    from: 'off'
    to: 'on'
  condition:
  - condition: numeric_state
    entity_id: sensor.luminosite
    below: '100'
  action:
  - type: turn_on
    device_id: 8394a13f5f95935a9b68bb19f625e4e7
    entity_id: light.tz3000_49qchf10_ts0502a_level_light_color_on_off
    domain: light
    brightness_pct: 0
  mode: single
- id: '1612184213140'
  alias: Bureau Ampoule off
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.detecteur_presence1_ias_zone
    from: 'on'
    to: 'off'
    for: 00:02:00
  condition: []
  action:
  - type: turn_off
    device_id: 8394a13f5f95935a9b68bb19f625e4e7
    entity_id: light.tz3000_49qchf10_ts0502a_level_light_color_on_off
    domain: light
  mode: single
- id: '1612536587598'
  alias: Piscine Appoint Eau On
  description: LSH = on si découvert
  trigger:
  - platform: state
    entity_id: cover.volet_piscine
    to: open
    for: 00:15:00
  - platform: state
    entity_id: input_boolean.ev_eau_piscine
    to: 'on'
  condition:
  - condition: state
    entity_id: input_boolean.ev_eau_piscine
    state: 'on'
  - condition: state
    entity_id: binary_sensor.tp_plein_lsh
    state: 'on'
  action:
  - service: switch.turn_on
    data: {}
    entity_id: switch.cde_ev_eau
  - service: notify.telegram
    data:
      message: Ouverture EV Eau {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Appoint Eau!
  mode: single
- id: '1612536671701'
  alias: Piscine Appoint Eau Off
  description: ''
  trigger:
  - platform: state
    entity_id: input_boolean.ev_eau_piscine
    from: 'on'
    to: 'off'
  - platform: state
    entity_id: binary_sensor.tp_plein_lsh
    to: 'off'
    from: 'on'
    for: 00:00:20
  condition:
  - condition: state
    entity_id: switch.cde_ev_eau
    state: 'on'
  action:
  - service: switch.turn_off
    data: {}
    entity_id: switch.cde_ev_eau
  - service: notify.telegram
    data:
      message: Fermeture EV Eau {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Appoint Eau!
  mode: single
- id: '1614244769739'
  alias: Lampe Desodo
  description: 'PC1 Lidl '
  trigger:
  - platform: time
    at: '19:30'
    id: '1'
  - platform: time
    at: '23:30'
    id: '2'
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: '1'
      sequence:
      - service: switch.turn_on
        target:
          entity_id: switch.pc1_lidl
    - conditions:
      - condition: trigger
        id: '2'
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.pc1_lidl
    default: []
  mode: single
- id: '1616955642150'
  alias: ECS_Integration énergie
  description: ''
  trigger:
  - platform: state
    entity_id: sensor.ecocompteur_ecs
  condition: []
  action:
  - service: python_script.energy1
    data:
      power: sensor.ecocompteur_ecs
      last_power: last_power_ecs
      energy_accum: energy_ecs_p
  mode: single
- id: '1616973133305'
  alias: Energie-energy integration
  description: Calcul énergie PZEM Totale
  trigger:
  - platform: state
    entity_id: sensor.pzem_totale_puissance
  condition: []
  action:
  - service: python_script.energy1
    data:
      power: sensor.pzem_totale_puissance
      last_power: last_power
      energy_accum: energy_power
  mode: single
- id: '1617008500219'
  alias: PAC_Energy integration
  description: Calcul énergie PAC
  trigger:
  - platform: state
    entity_id: sensor.puissance_pac_rpac
  condition: []
  action:
  - service: python_script.energy1
    data:
      power: sensor.puissance_pac_rpac
      last_power: last_power_pac
      energy_accum: energy_pac_p
  mode: single
- id: '1617185147880'
  alias: Piscine  Appoint d'eau Notification Alarme
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.ev_eau_tps_ouverture_jour
    above: '1.00'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: Temps ouverture supérieur à {{states('sensor.ev_eau_tps_ouverture_jour')}}
        h
      title: Alarme EV Appoint d'eau Piscine
  - service: switch.turn_off
    target:
      entity_id: switch.cde_ev_eau
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_alarme
  - service: input_text.set_value
    target:
      entity_id: input_text.text_def_l2
    data:
      value: Def EV eau
  mode: single
- id: '1617199790692'
  alias: Piscine Notification alarme niveau bas
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.tp_plein_lsl
    from: 'off'
    to: 'on'
    for: 00:00:10
  condition: []
  action:
  - service: notify.telegram
    data:
      title: ALARME
      message: Niveau bas Piscine
  - service: input_select.select_option
    data:
      option: 'Off'
    target:
      entity_id: input_select.pool_pump_mode
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_defaut
  - service: notify.telegram
    data:
      message: Niveau bas piscine{{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte Niveau Bas !!!
  mode: single
- id: '1617800736306'
  alias: Alarme T° Haute Congelo
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.temp_congelo_garage_2
    above: '-10'
    for: 00:10:00
  action:
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_defaut
  - service: input_text.set_value
    data:
      value: Congelo Temp Haute
    target:
      entity_id: input_text.text_def_l3
  - service: notify.telegram
    data:
      message: Temperature Haute Congelateur = {{states("sensor.temp_congelo_garage_2")
        }} °C{{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Alerte Temperature!!!
  mode: single
- id: '1617968589301'
  alias: Alarmo_ Activation Nuit
  description: ''
  trigger:
  - platform: time
    at: input_datetime.heure_debut_alarme_porte
  condition: []
  action:
  - service: alarm_control_panel.alarm_arm_night
    target:
      entity_id: alarm_control_panel.alarmo
  mode: single
- id: '1617968698367'
  alias: Alarmo_Desactivation
  description: ''
  trigger:
  - platform: time
    at: input_datetime.heure_fin_alarme_porte
  condition: []
  action:
  - service: alarm_control_panel.alarm_disarm
    target:
      entity_id: alarm_control_panel.alarmo
  mode: single
- id: '1619854078498'
  alias: Alarme BP_RAZ_Defaut
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.bp_raz
    to: 'on'
  condition: []
  action:
  - service: switch.turn_off
    target:
      entity_id:
      - switch.voyant_alarme
      - switch.voyant_defaut
      - switch.voyant_intrusion
      - switch.voyant_reseau
  - service: input_text.set_value
    data:
      value: .
    target:
      entity_id:
      - input_text.text_def_l1
      - input_text.text_def_l2
      - input_text.text_def_l3
      - input_text.text_def_l4
  mode: single
- id: '1620063975874'
  alias: Alarme Porte Frigo
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.detecteur_porte_2
    to: 'on'
    for: 00:01:00
  condition: []
  action:
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_alarme
  - service: input_text.set_value
    target:
      entity_id: input_text.text_def_l2
    data:
      value: Porte Frigo Ouv
  - service: notify.telegram
    data:
      message: Depuis 1 minute{{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Alerte Porte Frigo Garage Ouverte!!!
  mode: single
- id: '1620064561171'
  alias: Alarme porte Cellier
  description: ''
  trigger:
  - platform: sun
    event: sunset
  condition:
  - condition: state
    entity_id: binary_sensor.detecteur_porte_1
    state: 'on'
  action:
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_alarme
  - service: input_text.set_value
    target:
      entity_id: input_text.text_def_l2
    data:
      value: Porte Cellier Ouv
  - service: notify.telegram
    data:
      message: Au Coucher du Soleil{{-"\n"-}}{{as_timestamp(strptime(now(), "")) |
        timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Alerte Porte Cellier Ouverte!!!
  mode: single
- id: '1620064811764'
  alias: Alarme Porte SousSol
  description: ''
  trigger:
  - platform: sun
    event: sunset
  condition:
  - condition: state
    entity_id: binary_sensor.porte_ssol_fermee
    state: 'off'
  action:
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_alarme
  - service: input_text.set_value
    target:
      entity_id: input_text.text_def_l2
    data:
      value: Porte SSol Ouv
  - service: notify.telegram
    data:
      message: Au Coucher du Soleil{{-"\n"-}}{{as_timestamp(strptime(now(), "")) |
        timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Alerte Porte Sous-Sol Ouverte!!!
  mode: single
- id: '1620064923924'
  alias: Alarme Porte garage
  description: ''
  trigger:
  - platform: sun
    event: sunset
  condition:
  - condition: state
    entity_id: binary_sensor.porte_garage_fermee
    state: 'off'
  action:
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_alarme
  - service: input_text.set_value
    target:
      entity_id: input_text.text_def_l2
    data:
      value: Porte Garage Ouv
  - service: notify.telegram
    data:
      message: Au Coucher du Soleil{{-"\n"-}}{{as_timestamp(strptime(now(), "")) |
        timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Alerte Porte Garage Ouverte!!!
  mode: single
- id: '1620111095899'
  alias: Alarme Status PAC
  description: ''
  trigger:
  - platform: state
    entity_id: sensor.esp_altherma_status
    to: Offline
    for: 00:00:30
  condition: []
  action:
  - service: switch.turn_on
    target:
      entity_id: switch.voyant_defaut
  - service: input_text.set_value
    target:
      entity_id: input_text.text_def_l3
    data:
      value: Connect PAC HS
  - service: notify.telegram
    data:
      message: Comm PAC HS{{-"\n"-}}{{as_timestamp(strptime(now(), "")) |         timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Defaut Connection PAC
  mode: single
- id: '1620369077231'
  alias: Piscine Auto Hiver On-Provisoire
  description: ''
  trigger:
  - platform: time
    at: input_datetime.heure_debut_fil_hiv
  condition:
  - condition: state
    entity_id: input_boolean.swimming_season
    state: 'off'
  action:
  - service: input_select.select_option
    target:
      entity_id: input_select.pool_pump_mode
    data:
      option: 'On'
  - delay:
      hours: 3
      minutes: 30
      seconds: 0
      milliseconds: 0
  - service: input_select.select_option
    target:
      entity_id: input_select.pool_pump_mode
    data:
      option: 'Off'
  mode: single
- id: '1622182531449'
  alias: Piscine Volet Ouv/Ferm Horaires
  description: Suivant tranches horaires
  trigger:
  - platform: time
    at: input_datetime.heure_ferm_volet_pisc
    id: ferm
  - platform: time
    at: input_datetime.heure_ouv_volet_pisc
    id: ouv
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: ferm
      - condition: state
        entity_id: input_boolean.volet_piscine_auto
        state: 'on'
      sequence:
      - service: script.volet_piscine_fermeture
    - conditions:
      - condition: trigger
        id: ouv
      - condition: state
        entity_id: input_boolean.volet_piscine_auto
        state: 'on'
      sequence:
      - service: script.volet_piscine_ouverture
    default: []
  mode: single
- id: '1623911201023'
  alias: Piscine Mémorisation Température avant arrêt
  description: 'On fait tourner la pompe 15 mn avant prise en compte de la température '
  trigger:
  - platform: time_pattern
    minutes: /1
  condition:
  - condition: state
    entity_id: binary_sensor.pool_pump_running
    state: 'on'
    for: 00:15:00
  action:
  - service: input_number.set_value
    target:
      entity_id: input_number.mem_temp_piscine
    data_template:
      value: '{{ states(''sensor.temp_piscine'')|float }}'
  mode: single
- id: '1559049859759'
  alias: Piscine ph Haut
  trigger:
  - platform: numeric_state
    entity_id: sensor.ph_piscine_ph
    above: '7.8'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: Ph Haut = {{states('sensor.ph_piscine_ph') }}{{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte pH !!!
  initial_state: true
  mode: single
- id: '1559049839760'
  alias: Piscine ph bas
  trigger:
  - platform: numeric_state
    entity_id: sensor.ph_piscine_ph
    below: '6.9'
    above: '0'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: Ph Bas = {{states('sensor.ph_piscine_ph') }}{{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte pH !!!
  initial_state: true
  mode: single
- id: '1559049893756'
  alias: Piscine ph Anormal
  trigger:
  - platform: template
    value_template: '{{state_attr("sensor.ph_stat", "standard_deviation") | float  >
      0.1}}'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: Ph Mauvais sonde à calibrer??{{-"\n"-}} Moyenne = {{state_attr("sensor.ph_stat",
        "mean")}}{{-"\n"-}} Deviation(S=0.01) = {{state_attr("sensor.ph_stat", "standard_deviation")}}
        {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte pH !!!
  initial_state: true
  mode: single
- id: '1624083693650'
  alias: Piscine pH Validation Automatismes
  description: 'Valide les automations régulation pH au bout de 1 h de fonctionnement '
  trigger:
  - platform: state
    entity_id: binary_sensor.pool_pump_running
    for:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 0
    to: 'on'
    from: 'off'
    id: ma_pump
  - platform: state
    entity_id: binary_sensor.pool_pump_running
    id: at_pump
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 10
      milliseconds: 0
  - platform: state
    entity_id: input_boolean.regul_ph
    id: regule_ph_off
    from: 'on'
    to: 'off'
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: ma_pump
      - condition: state
        entity_id: input_boolean.regul_ph
        state: 'on'
      sequence:
      - service: automation.turn_on
        target:
          entity_id:
          - automation.ph_bas
          - automation.ph_haut
          - automation.ph_mauvais
          - automation.piscine_injection_v2
      - service: notify.telegram
        data:
          message: pH sonde= {{states('sensor.ph_piscine_ph')}} {{-"\n"-}}{{as_timestamp(strptime(now(),
            "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
          title: Piscine Activation Traitement pH !
    - conditions:
      - condition: trigger
        id: at_pump
      sequence:
      - service: automation.turn_off
        target:
          entity_id:
          - automation.ph_bas
          - automation.ph_haut
          - automation.ph_mauvais
          - automation.piscine_injection_v2
    - conditions:
      - condition: trigger
        id: regule_ph_off
      sequence:
      - service: automation.turn_off
        target:
          entity_id:
          - automation.ph_bas
          - automation.ph_haut
          - automation.ph_mauvais
          - automation.piscine_injection_v2
    default: []
  mode: single
- id: '1624381456670'
  alias: Piscine Pression haute
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.pression_piscine_p
    above: '1.0'
    for: 00:15:00
  condition: []
  action:
  - service: notify.telegram
    data:
      message: Pression Haute = {{states("sensor.pression_piscine_p") }}{{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte Pression Filtre !!!
  mode: single
- id: '1624519865531'
  alias: Piscine pH Niveau Bas Bidon
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.ph_niveau_bas_bidon
    to: 'on'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: Volume Restant = {{(states("sensor.ph_volume_restant_bidon"))|round(2)
        }} l{{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte niveau Bas Bidon pH !!!
  mode: single
- id: '1624688264761'
  alias: Reseau_Notification PING
  description: ''
  trigger:
  - platform: state
    entity_id: group.ping_reseau
    to: 'off'
    id: defaut
    from: 'on'
  - platform: state
    entity_id: group.ping_reseau
    id: ok
    from: 'off'
    to: 'on'
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: defaut
      sequence:
      - service: notify.telegram
        data:
          message: Un PING est HS{{-"\n"-}} -> NAS Dlink est {{states('binary_sensor.nas_dlink')}}{{-"\n"-}}
            -> Eco_Compteur est {{states('binary_sensor.ping_eco_compteur')}}{{-"\n"-}}
            -> Rpi_Adguard est {{states('binary_sensor.ping_rpi_adguard')}}{{-"\n"-}}
            -> Module Adam est {{states('binary_sensor.ping_module_adam')}}{{-"\n"-}}
            -> Wago Piscine est {{states('binary_sensor.ping_module_wago_piscine')}}{{-"\n"-}}
            -> ESP123 PZEM SdB est {{states('binary_sensor.ping_esp123_pezm_sdb')}}{{-"\n"-}}
            -> ESP125 Piscine est {{states('binary_sensor.ping_esp125_piscine')}}{{-"\n"-}}
            -> ESP132 PEZM Total est {{states('binary_sensor.ping_esp132_pezm_totale')}}{{-"\n"-}}
            -> ESP133 Congelo {{states('binary_sensor.ping_esp133_congelateur')}}{{-"\n"-}}
            -> ESP134 UV est {{states('binary_sensor.ping_esp134_uv')}}{{-"\n"-}}
            -> ESP135 Luxmetre est {{states('binary_sensor.ping_esp135_luxmetre')}}{{-"\n"-}}
            -> ESP137 PEZM Piscine est {{states('binary_sensor.ping_esp137_pzem_piscine')}}{{-"\n"-}}
            -> ESP139 VMCSSol est {{states('binary_sensor.ping_esp139_vmc_sous_sol')}}{{-"\n"-}}
            -> Cam Cuisine est {{states('binary_sensor.cam_cuisine')}}{{-"\n"-}} ->
            Cam Gar Ext est {{states('binary_sensor.cam_garage_ext')}}{{-"\n"-}} ->
            Cam Gar Int est {{states('binary_sensor.cam_garage_int')}}{{-"\n"-}} ->
            Cam Piscine est {{states('binary_sensor.cam_piscine')}}{{-"\n"-}} -> Cam
            Salon est {{states('binary_sensor.cam_salon')}}{{-"\n"-}} -> Cam terrasse
            est {{states('binary_sensor.cam_terrasse')}}{{-"\n"-}} {{as_timestamp(strptime(now(),
            "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
          title: Défaut Réseau:!!!
      - service: input_text.set_value
        target:
          entity_id: input_text.text_def_l1
        data:
          value: Un PING est HS
      - service: persistent_notification.create
        data:
          message: Un PING est HS
      - service: switch.turn_on
        target:
          entity_id: switch.voyant_reseau
    - conditions:
      - condition: trigger
        id: ok
      sequence:
      - service: notify.telegram
        data:
          message: PING OK{{-"\n"-}} {{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
          title: Défaut Réseau:!!!
      - service: persistent_notification.create
        data:
          message: Un PING est OK
    default: []
  mode: single
- id: '1624811066593'
  alias: Piscine pH Injection
  description: ''
  trigger:
  - platform: time_pattern
    hours: /1
  condition:
  - condition: template
    value_template: '{% set a=states(''sensor.ph_piscine_ph'') | float %}

      {% set b=states(''input_number.ph_cible'') | float %}

      {{ a > b }}'
  - condition: numeric_state
    entity_id: sensor.ph_piscine_ph
    above: '0'
  - condition: state
    entity_id: input_boolean.regul_ph
    state: 'on'
  action:
  - service: input_number.set_value
    target:
      entity_id: input_number.ph_duree_inject_s
    data_template:
      value: '{{ states(''sensor.ph_tps_inject_s'')|float }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.ph_duree_inject_mn
    data_template:
      value: '{{ states(''sensor.ph_tps_inject_mn'')|float }}'
  - service: switch.turn_on
    target:
      entity_id:
      - switch.cde_traitement
  - service: notify.telegram
    data:
      message: pH sonde= {{states('sensor.ph_piscine_ph')}} {{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Début injection pH !!!
  - delay: 00:{{ states('input_number.ph_duree_inject_mn')|int}}:{{ states('input_number.ph_duree_inject_s')
      | int }}
  - service: input_number.set_value
    data_template:
      entity_id: input_number.ph_vol_injecte
      value: '{% set a=states(''input_number.ph_vol_injecte'')|float %} {% set b=states(''input_number.ph_debit_ppe'')|float
        %} {% set c=states(''input_number.ph_duree_inject_s'')|float %} {% set d=states(''input_number.ph_duree_inject_mn'')|float
        %} {{a+( (b*((d*60)+c)/3600))|round(2) }}'
  - service: switch.turn_off
    target:
      entity_id: switch.cde_traitement
  - service: notify.telegram
    data:
      message: pH sonde= {{states('sensor.ph_piscine_ph')}}{{-"\n"-}} Vol Injecté
        =  {% set b=states('input_number.ph_debit_ppe')|float %} {% set c=states('input_number.ph_duree_inject_s')|float
        %} {% set d=states('input_number.ph_duree_inject_mn')|float %} {{(b*((d*60)+c)/3600)|round(2)
        }} l {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Fin injection pH !!!
  mode: single
- id: '1624864713180'
  alias: Piscine Cartouche Chlore
  description: Mémorisation du temps d''utilisation cartouche chlore hedbo- RAZ à
    la main
  trigger:
  - platform: time
    at: '23:50:00'
  condition: []
  action:
  - service: input_number.set_value
    data_template:
      entity_id: input_number.temps_cartouche_chlore
      value: '{% set a=states(''input_number.temps_cartouche_chlore'')|float %} {%
        set b=states(''sensor.pool_pump_running_today'')|float %} {{ (a + b)|round(2)
        }}'
  mode: single
- id: '1625162846851'
  alias: Piscine Temps utilisation cartouche chlore atteint
  description: ''
  trigger:
  - platform: template
    value_template: '{% set a=states(''input_number.temps_cartouche_chlore'') | float
      %}

      {% set b=states(''input_number.chlore_seuil_max_utilisation'') | float %}

      {{ a > b }}'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: 'Tps Utilisation cart. Chlore = {{states(''input_number.temps_cartouche_chlore'')}}
        h {{-"\n"-}} Temps maxi:  {{states(''input_number.chlore_seuil_max_utilisation'')}}
        h {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom(''%d/%m/%y-%H:%M:%S'')}}'
      title: Piscine Alerte Cartouche Chlore à changer!!!
  mode: single
- id: '1625215180800'
  alias: Piscine pH Mémorisation valeur arret
  description: ''
  trigger:
  - platform: time_pattern
    minutes: /1
  condition:
  - condition: state
    entity_id: binary_sensor.pool_pump_running
    state: 'on'
    for: 00:30:00
  action:
  - service: input_number.set_value
    target:
      entity_id: input_number.ph_memoire
    data_template:
      value: '{{ states("sensor.ph_ezo") | float |round(2) }}'
  mode: single
- id: '1625215180801'
  alias: Piscine ORP Mémorisation valeur avant arrêt
  description: ''
  trigger:
  - platform: time_pattern
    minutes: /1
  condition:
  - condition: state
    entity_id: binary_sensor.pool_pump_running
    state: 'on'
    for: 00:15:00
  action:
  - service: input_number.set_value
    target:
      entity_id: input_number.orp_memoire
    data_template:
      value: '{{ states("sensor.orp_ezo") | float |round(2) }}'
  mode: single
- id: '1559049859762'
  alias: Piscine ORP Haut
  trigger:
  - platform: numeric_state
    entity_id: sensor.orp_piscine_orp
    above: '900.0'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: ORP Haut = {{states('sensor.orp_piscine_orp') }}{{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte ORP !!!
  initial_state: true
  mode: single
- id: '1559049839763'
  alias: Piscine ORP bas
  trigger:
  - platform: numeric_state
    entity_id: sensor.orp_piscine_orp
    below: '600.0'
    above: '0'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: ORP Bas = {{states('sensor.orp_piscine_orp') }}{{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte ORP !!!
  initial_state: true
  mode: single
- id: '1559049893757'
  alias: Piscine ORP Anormal
  trigger:
  - platform: template
    value_template: '{{state_attr("sensor.orp_stat", "standard_deviation") | float  >
      0.1}}'
  condition: []
  action:
  - service: notify.telegram
    data:
      message: ORP Mauvais sonde à calibrer??{{-"\n"-}} Moyenne = {{state_attr("sensor.orp_stat",
        "mean")}}{{-"\n"-}} Deviation(S=0.01) = {{state_attr("sensor.orp_stat", "standard_deviation")}}
        {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Alerte ORP !!!
  initial_state: true
  mode: single
- id: '1624811066594'
  alias: Piscine Chlore Injection
  description: ''
  trigger:
  - platform: time_pattern
    hours: /1
  condition:
  - condition: template
    value_template: '{% set a=states(''sensor.orp_piscine_orp'') | float %}

      {% set b=states(''input_number.orp_cible'') | float %}

      {{ a > b }}'
  - condition: numeric_state
    entity_id: sensor.orp_piscine_orp
    above: '0'
  - condition: state
    entity_id: input_boolean.regul_orp
    state: 'on'
  action:
  - service: input_number.set_value
    target:
      entity_id: input_number.chlore_duree_inject_s
    data_template:
      value: '{{ states(''sensor.chlore_tps_inject_s'')|float }}'
  - service: input_number.set_value
    target:
      entity_id: input_number.chlore_duree_inject_mn
    data_template:
      value: '{{ states(''sensor.chlore_tps_inject_mn'')|float }}'
  - service: switch.turn_on
    target:
      entity_id:
      - switch.cde_ppe_chlore
  - service: notify.telegram
    data:
      message: ORP sonde= {{states('sensor.orp_piscine_orp')}} {{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Début injection Chlore !!!
  - delay: 00:{{ states('input_number.chlore_duree_inject_mn')|int}}:{{ states('input_number.chlore_duree_inject_s')
      | int }}
  - service: input_number.set_value
    data_template:
      entity_id: input_number.chlore_vol_injecte
      value: '{% set a=states(''input_number.chlore_vol_injecte'')|float %} {% set
        b=states(''input_number.chlore_debit_ppe'')|float %} {% set c=states(''input_number.chlore_duree_inject_s'')|float
        %} {% set d=states(''input_number.chlore_duree_inject_mn'')|float %} {{a+(
        (b*((d*60)+c)/3600))|round(2) }}'
  - service: switch.turn_off
    target:
      entity_id: switch.cde_ppe_chlore
  - service: notify.telegram
    data:
      message: ORP sonde= {{states('sensor.orp_piscine_orp')}}{{-"\n"-}} Vol Injecté
        =  {% set b=states('input_number.chlore_debit_ppe')|float %} {% set c=states('input_number.chlore_duree_inject_s')|float
        %} {% set d=states('input_number.chlore_duree_inject_mn')|float %} {{(b*((d*60)+c)/3600)|round(2)
        }} l {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Fin injection Chlore !!!
  mode: single
- id: '1624083693660'
  alias: Piscine Chlore Traitement On
  description: Valide les automations régulation pH au bout de 1 h de fonctionnement
  trigger:
  - platform: state
    entity_id: binary_sensor.pool_pump_running
    for: 01:00:00
    to: 'on'
  condition:
  - condition: state
    entity_id: input_boolean.regul_chlore
    state: 'on'
  action:
  - service: automation.turn_on
    target:
      entity_id:
      - automation.orp_bas
      - automation.orp_haut
      - automation.orp_mauvais
      - automation.piscine_injection_chlore
  - service: notify.telegram
    data:
      message: ORP sonde= {{states('sensor.orp_piscine_orp')}} {{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Piscine Activation Traitement Chlore !
  mode: single
- id: '1624083788324'
  alias: Piscine Chlore Traitement Off
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.pool_pump_running
    to: 'off'
  - platform: state
    entity_id: input_boolean.regul_chlore
    to: 'off'
  condition: []
  action:
  - service: automation.turn_off
    target:
      entity_id:
      - automation.orp_bas
      - automation.orp_haut
      - automation.orp_mauvais
      - automation.piscine_injection_chlore
  - service: switch.turn_off
    target:
      entity_id: switch.cde_ppe_chlore
  mode: single
- id: '1629296468909'
  alias: Robot_Stop Pluie
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.vp2_pluviometrie_moyenne
    above: input_number.seuil_pluie_stop_robot
  condition:
  - condition: state
    entity_id: input_boolean.robot_valide
    state: 'on'
  action:
  - service: vacuum.return_to_base
    target:
      entity_id: vacuum.automower_r_435x_am435x_awd
  - service: notify.telegram
    data:
      message: Retour Robot à la Base!!{{-"\n"-}} Pluvio Moyenne 12h = {{states('sensor.vp2_pluviometrie_moyenne')}}
        mm {{-"\n"-}} Seuil Stop robot= {{states('input_number.seuil_pluie_stop_robot')}}
        mm {{-"\n"-}}{{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
      title: Alerte Meteo Pluie !!!
  mode: single
- id: '1629792204535'
  alias: Volet_Proport_Bureau_droit
  description: Mise à jour Position fermé (=0)
  trigger:
  - platform: state
    entity_id: binary_sensor.volet_buro_droit_ias_zone
    to: 'off'
  condition: []
  action:
  - service: cover_rf_time_based.set_known_position
    data:
      entity_id: cover.volet_droit_p
      position: 0
  mode: single
- id: '1629817943890'
  alias: Meteo_Alerte quand pluie attendue
  description: Envoie des notifications quand la pluie est attendue dans l'heure
  trigger:
  - platform: state
    entity_id: sensor.albi_next_rain
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ trigger.to_state.state != "unknown" }}'
      - condition: state
        entity_id: input_boolean.stop_notif_previ_pluie
        state: 'off'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ trigger.to_state.state != trigger.from_state.state
              }}'
          sequence:
          - service: notify.telegram
            data:
              message: 'La pluie est attendue à {{ as_timestamp(states(''sensor.albi_next_rain''))
                | timestamp_custom(''%H:%M'', True) }}.

                '
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ state_attr("sensor.albi_next_rain", "1_hour_forecast")["0
              min"] != "Temps sec" }}'
          sequence:
          - service: input_boolean.turn_on
            data:
              entity_id: input_boolean.stop_notif_previ_pluie
          - condition: time
            before: '21:30'
            after: '10:00:00'
    - conditions:
      - condition: template
        value_template: '{{ trigger.to_state.state == "unknown" }}'
      - condition: template
        value_template: '{{ trigger.from_state.state != "unknown" }}'
      sequence:
      - service: notify.telegram
        data:
          message: Plus de pluie attendue dans la prochaine heure.
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.stop_notif_previ_pluie
  mode: single
- id: '1629792204665'
  alias: Meteo_Notification si alerte météo en cours
  description: Envoie une notification sur Telegram si une alerte météo est levée
    par Météo-France
  trigger:
  - platform: state
    entity_id: sensor.81_weather_alert
  condition:
  - condition: template
    value_template: '{% if (is_state(''sensor.81_weather_alert'', ''Vert'') or is_state(''sensor.81_weather_alert'',
      ''unavailable'') )  %}false{% else %}true{% endif %}'
  action:
  - service: notify.telegram
    data_template:
      message: "Alerte météo {{states('sensor.81_weather_alert')}} en cours:\n {%-\
        \ for attr in ['Vent violent', 'Pluie-inondation', 'Orages', 'Inondation',\
        \ 'Neige-verglas', 'Canicule', 'Grand-froid', 'Avalanches', 'Vagues-submersion']\
        \ -%} {%- if state_attr('sensor.81_weather_alert', attr) != 'Vert' and state_attr('sensor.81_weather_alert',\
        \ attr) != None %}\n - {{attr}}: {{state_attr('sensor.81_weather_alert', attr)}}\
        \ {%- endif -%} {%- endfor -%}{{-\"\\n\"-}}{{as_timestamp(strptime(now(),\
        \ \"\")) |\ntimestamp_custom('%d/%m/%y-%H:%M:%S')}}"
  mode: single
- id: '1629792266535'
  alias: Meteo_Notification si alerte météo terminée
  description: Envoie un notification sur Telegram si toutes les alertes météos sont
    terminées
  trigger:
  - platform: state
    entity_id: sensor.81_weather_alert
    to: Vert
  condition:
  - condition: template
    value_template: '{% if trigger.from_state.state != ''unavailable'' %}true{% endif
      %}'
  action:
  - service: notify.telegram
    data_template:
      message: Fin de l'alerte météo.{{-"\n"-}}{{as_timestamp(strptime(now(), ""))
        | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
  mode: single
- id: '1630733178074'
  alias: Volet_Pos_Soleil_sbd
  description: 'Ferme et ouvre les volets SDB et Amis Nord en fonction du soleil et
    de la radiation '
  trigger:
  - platform: state
    entity_id: binary_sensor.volet_soleil_ferm_sdb
    to: 'on'
    for: 00:02:00
    from: 'off'
    id: ouv->ferm
  - platform: state
    entity_id: binary_sensor.volet_soleil_ferm_sdb
    id: ferm->ouv
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  condition:
  - condition: state
    entity_id: input_boolean.val_automs_soleil
    state: 'on'
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_boolean.presence_amis_ch_nord
        state: 'off'
      - condition: trigger
        id: ouv->ferm
      sequence:
      - service: cover.close_cover
        target:
          entity_id:
          - cover.sdb
          - cover.amis_nord
    - conditions:
      - condition: state
        entity_id: input_boolean.presence_amis_ch_nord
        state: 'on'
      - condition: trigger
        id: ouv->ferm
      sequence:
      - service: cover.close_cover
        target:
          entity_id: cover.sdb
    - conditions:
      - condition: trigger
        id: ferm->ouv
      - condition: state
        entity_id: input_boolean.presence_amis_ch_nord
        state: 'off'
      sequence:
      - service: cover.open_cover
        target:
          entity_id:
          - cover.sdb
          - cover.amis_nord
    - conditions:
      - condition: trigger
        id: ferm->ouv
      - condition: state
        entity_id: input_boolean.presence_amis_ch_nord
        state: 'on'
      sequence:
      - service: cover.open_cover
        target:
          entity_id: cover.sdb
    default: []
  mode: single
- id: '1630737279080'
  alias: Volet_Pos_Soleil_Sud
  description: ''
  trigger:
  - platform: state
    entity_id: binary_sensor.volet_soleil_ferm_sud
    to: 'on'
    for: 00:02:00
    from: 'off'
    id: ouv->ferm
  - platform: state
    entity_id: binary_sensor.volet_soleil_ferm_sud
    from: 'on'
    to: 'off'
    id: ferm->ouv
  condition:
  - condition: state
    entity_id: input_boolean.val_automs_soleil
    state: 'on'
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_boolean.presence_amis_ch_sud
        state: 'off'
      - condition: trigger
        id: ouv->ferm
      sequence:
      - service: cover.close_cover
        target:
          entity_id:
          - cover.parents_petit
          - cover.amis_sud_petit
    - conditions:
      - condition: state
        entity_id: input_boolean.presence_amis_ch_sud
        state: 'on'
      - condition: trigger
        id: ouv->ferm
      sequence:
      - service: cover.close_cover
        target:
          entity_id: cover.parents_petit
    - conditions:
      - condition: trigger
        id: ferm->ouv
      - condition: state
        entity_id: input_boolean.presence_amis_ch_sud
        state: 'off'
      sequence:
      - service: cover.open_cover
        target:
          entity_id:
          - cover.parents_petit
          - cover.amis_sud_petit
    - conditions:
      - condition: trigger
        id: ferm->ouv
      - condition: state
        entity_id: input_boolean.presence_amis_ch_sud
        state: 'on'
      sequence:
      - service: cover.open_cover
        target:
          entity_id: cover.parents_petit
    default: []
  mode: single
- id: '1630914740344'
  alias: Balise
  description: ''
  trigger:
  - platform: tag
    tag_id: e1fbd7f1-da40-4f4d-a300-76b3175a1d2c
  condition: []
  action:
  - service: switch.toggle
    target:
      entity_id: switch.pump
  mode: single
- id: '1632232387237'
  alias: Reseau_Notification Nouvelle IP
  description: ''
  trigger:
  - platform: state
    entity_id: sensor.ip_public
  condition: []
  action:
  - service: notify.telegram
    data:
      message: 'Nouvelle IP: {{ states(''sensor.ip_public'')}} {{-"\n"-}}{{as_timestamp(strptime(now(),
        "")) | timestamp_custom(''%d/%m/%y-%H:%M:%S'')}}'
      title: Réseau:!!!
  - service: persistent_notification.create
    data:
      message: Nouvelle IP
  mode: single
- id: '1634688274761'
  alias: Reseau_Notification ESP
  description: ''
  trigger:
  - platform: state
    entity_id: group.esp_reseau
    from: 'on'
    to: 'off'
    id: defaut
  - platform: state
    entity_id: group.esp_reseau
    id: ok
    from: 'off'
    to: 'on'
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: defaut
      sequence:
      - service: notify.telegram
        data:
          message: Un ESP est HS{{-"\n"-}} -> ESP PEZM SdB est {{states('binary_sensor.esp123_status')}}{{-"\n"-}}
            -> ESP Piscine est {{states('binary_sensor.esp125_status')}}{{-"\n"-}}
            -> ESP PZEM Total est {{states('binary_sensor.esp132_status')}}{{-"\n"-}}
            -> ESP Congelo est {{states('binary_sensor.esp133_status')}}{{-"\n"-}}
            -> ESP Mesure UV est {{states('binary_sensor.esp134_status')}}{{-"\n"-}}
            -> ESP Luxmetre est {{states('binary_sensor.esp135_status')}}{{-"\n"-}}
            -> ESP PZEM Piscine est {{states('binary_sensor.esp137_status')}}{{-"\n"-}}
            -> ESP Voyant Alarm est {{states('binary_sensor.esp138_status')}}{{-"\n"-}}
            -> ESP VMC SSol est {{states('binary_sensor.esp139_status')}}{{-"\n"-}}
            -> ESP Test8266 est {{states('binary_sensor.esp140_status')}}{{-"\n"-}}
            {{as_timestamp(strptime(now(), "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
          title: Défaut ESP !!!
      - service: switch.turn_on
        target:
          entity_id: switch.voyant_reseau
      - service: input_text.set_value
        target:
          entity_id: input_text.text_def_l1
        data:
          value: ESP Deconnecte
      - service: persistent_notification.create
        data:
          message: ESP Deconnecté
    - conditions:
      - condition: trigger
        id: ok
      sequence:
      - service: notify.telegram
        data:
          message: Les ESP sont OK :) {{-"\n"-}}{{as_timestamp(strptime(now(), ""))
            | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
          title: ESP OK !!!
      - service: persistent_notification.create
        data:
          message: ESP OK
      - service: notify.mobile_app_oneplus_a5010
    default: []
  mode: single
- id: '1645688274761'
  alias: 'Reseau_Notification UPTIME '
  description: ''
  trigger:
  - platform: state
    entity_id: group.uptime_reseau
    to: 'off'
    id: defaut
    from: 'on'
  - platform: state
    entity_id: group.uptime_reseau
    id: ok
    from: 'off'
    to: 'on'
  condition: []
  action:
  - choose:
    - conditions:
      - condition: trigger
        id: defaut
      sequence:
      - service: notify.telegram
        data:
          message: Un Serveur WEB est HS{{-"\n"-}} -> Blog DOMO Rem81 est {{states('binary_sensor.domo_rem81')}}{{-"\n"-}}
            -> Jeedom est {{states('binary_sensor.jeedom')}}{{-"\n"-}} -> ZIMETEO
            est {{states('binary_sensor.meteo81000')}}{{-"\n"-}} -> Meteo VP2 est
            {{states('binary_sensor.meteoweewx')}}{{-"\n"-}} -> HA est {{states('binary_sensor.ha')}}{{-"\n"-}}
            -> MotionEye est {{states('binary_sensor.motioneye')}}{{-"\n"-}} {{as_timestamp(strptime(now(),
            "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
          title: Défaut Reseau UPTIME !!!
      - service: switch.turn_on
        target:
          entity_id: switch.voyant_reseau
      - service: input_text.set_value
        target:
          entity_id: input_text.text_def_l1
        data:
          value: UPTIME Deconnecte
      - service: persistent_notification.create
        data:
          message: UPTIME Deconnecté
    - conditions:
      - condition: trigger
        id: ok
      sequence:
      - service: notify.telegram
        data:
          message: Les acces WEB sont OK :) {{-"\n"-}}{{as_timestamp(strptime(now(),
            "")) | timestamp_custom('%d/%m/%y-%H:%M:%S')}}
          title: Reseau UPTIME OK !!!
      - service: persistent_notification.create
        data:
          message: UPTIME Deconnecté
      - service: notify.mobile_app_oneplus_a5010
        data:
          message: Reseau Uptime ok
    default: []
  mode: single
- id: '1632989157968'
  alias: Volet_Automatismes
  description: Ete/Hiver/Absent
  trigger:
  - platform: state
    entity_id: input_boolean.nuit_jour
    from: 'on'
    to: 'off'
    id: jour->nuit
  - platform: time
    at: input_datetime.horaire_ete_volet_ouv
    id: ouv
  - platform: time
    at: input_datetime.horaire_ete_volet_ferm
    id: ferm
  - platform: state
    entity_id: input_boolean.nuit_jour
    id: nuit->jour
    from: 'off'
    to: 'on'
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_select.volets
        state: Auto Hiv
      - condition: trigger
        id: jour->nuit
      sequence:
      - service: script.fermeture_volet
    - conditions:
      - condition: state
        entity_id: input_select.volets
        state: Auto Hiv
      - condition: trigger
        id: nuit->jour
      sequence:
      - service: script.ouverture_volet
    - conditions:
      - condition: state
        entity_id: input_select.volets
        state: Auto Ete
      - condition: trigger
        id: ouv
      sequence:
      - service: script.ouverture_volet
    - conditions:
      - condition: state
        entity_id: input_select.volets
        state: Auto Ete
      - condition: trigger
        id: ferm
      sequence:
      - service: script.fermeture_volet
    - conditions:
      - condition: state
        entity_id: input_select.volets
        state: Absent
      - condition: state
        entity_id: input_boolean.nuit_jour
        state: 'off'
      sequence:
      - service: script.fermeture_volet_absent
    - conditions:
      - condition: state
        entity_id: input_select.volets
        state: Absent
      - condition: state
        entity_id: input_boolean.nuit_jour
        state: 'on'
      sequence:
      - service: script.ouverture_volet_absent
    default: []
  mode: single
- id: '1632994496716'
  alias: VMC_Sous_Sol_Automatismes
  description: ''
  trigger:
  - platform: state
    entity_id: input_select.vmc_ssol
  - platform: time
    id: debut
    at: input_datetime.horaire_vmc_debut
  - platform: time
    id: fin
    at: input_datetime.horaire_vmc_fin
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_select.vmc_ssol
        state: Auto
      - condition: trigger
        id: debut
      sequence:
      - service: switch.turn_on
        target:
          entity_id: switch.vmc_ssol
    - conditions:
      - condition: state
        entity_id: input_select.vmc_ssol
        state: Auto
      - condition: trigger
        id: fin
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.vmc_ssol
    - conditions:
      - condition: state
        entity_id: input_select.vmc_ssol
        state: Arret
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.vmc_ssol
    - conditions:
      - condition: state
        entity_id: input_select.vmc_ssol
        state: Marche
      sequence:
      - service: switch.turn_on
        target:
          entity_id: switch.vmc_ssol
    default: []
  mode: single
- id: '1632995598078'
  alias: ECS_Automatisations
  description: ''
  trigger:
  - platform: state
    entity_id: input_select.ecs_ssol
  - platform: time
    id: debut
    at: input_datetime.horaire_ecs_debut
  - platform: time
    id: fin
    at: input_datetime.horaire_ecs_fin
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_select.ecs_ssol
        state: Auto
      - condition: trigger
        id: debut
      sequence:
      - service: script.ecs_on
    - conditions:
      - condition: state
        entity_id: input_select.ecs_ssol
        state: Auto
      - condition: trigger
        id: fin
      sequence:
      - service: script.ecs_off
    - conditions:
      - condition: state
        entity_id: input_select.ecs_ssol
        state: Arret
      sequence:
      - service: switch.turn_off
        target:
          entity_id:
          - switch.cde_relais_ecs
          - switch.cde_relais_ecs_router_pv
    - conditions:
      - condition: state
        entity_id: input_select.ecs_ssol
        state: Marche ECS
      sequence:
      - service: switch.turn_on
        target:
          entity_id: switch.cde_relais_ecs
      - service: switch.turn_off
        target:
          entity_id: switch.cde_relais_ecs_router_pv
    - conditions:
      - condition: state
        entity_id: input_select.ecs_ssol
        state: Marche PV
      sequence:
      - service: switch.turn_off
        target:
          entity_id: switch.cde_relais_ecs
      - service: switch.turn_on
        target:
          entity_id: switch.cde_relais_ecs_router_pv
    default: []
  mode: single
- id: '1633075302563'
  alias: Piscine Hors-Gel Actions
  description: ''
  trigger:
  - platform: state
    entity_id: input_boolean.hors_gel
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_boolean.hors_gel
        state: 'on'
      sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.pool_pump_mode
        data:
          option: 'On'
      - service: notify.telegram
        data:
          message: '{{as_timestamp(strptime(now(), "")) | timestamp_custom(''%d/%m
            %H:%M:%S'')}}'
          title: Piscine Hors-Gel Activé
    - conditions:
      - condition: state
        entity_id: input_boolean.hors_gel
        state: 'off'
      sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.pool_pump_mode
        data:
          option: Auto
      - service: notify.telegram
        data:
          message: '{{as_timestamp(strptime(now(), "")) | timestamp_custom(''%d/%m
            %H:%M:%S'')}}'
          title: Piscine Hors-Gel Désactivé
    default: []
  mode: single
